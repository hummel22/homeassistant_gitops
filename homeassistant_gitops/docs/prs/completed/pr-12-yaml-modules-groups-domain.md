# PR-12: YAML Modules - add `groups.yaml` as a first-class domain

## Summary

Extend YAML Modules to support GitOps-managed Home Assistant `group.*` entities via a first-class
`groups.yaml` mapping domain.

- Domain files (generated by GitOps Bridge):
  - `/config/groups.yaml` (for `group: !include groups.yaml`)
- Module dir: `/config/groups/`
- Package module file: `/config/packages/<pkg>/groups.yaml`
- Canonical unassigned file: `/config/groups/groups.unassigned.yaml`
- Mapping file: `/config/.gitops/mappings/group.yaml`

This PR provides the backend foundation needed for group export/import and a groups dashboard.

## Motivation

Groups are a common way to represent "collections" of entities and are frequently edited in the UI.
YAML Modules should be able to keep groups in version control just like automations, scripts, and
helpers.

## Goals

- Add a new YAML Modules domain spec for groups.
- Treat groups as a mapping domain (key -> group definition).
- Support sync/build/update conflict behavior consistent with other mapping domains (scripts).
- Ensure module browser/index includes the `groups/` folder.
- Ensure item APIs work for groups (list/read/write a single group entry).
- Support Home Assistant-style `!include` usage inside group definitions by resolving includes during
  YAML expansion so the generated `groups.yaml` does not need `!include` tags.

## Non-goals

- A dedicated UI for managing groups (separate PR).
- Importing UI-managed groups into YAML automatically (separate PR).
- Auto-modifying `configuration.yaml` to include groups (operator action; v1 warns only).

## Operator-facing requirements

Home Assistant only uses `groups.yaml` if it is included from `configuration.yaml`, e.g.:

```yaml
group: !include groups.yaml
```

This PR should surface a clear warning/message (UI + API warnings) if GitOps Bridge is generating
`groups.yaml` but `configuration.yaml` does not include it.

## Implementation notes

### Domain modeling

- Add a `DomainSpec` for `group`:
  - `key: "group"`
  - `kind: "mapping"`
  - `domain_file: groups.yaml`
  - `module_dir: groups/`
  - `package_filename: groups.yaml`

Group IDs:

- Use `object_id` (key in YAML, e.g. `kitchen`) as the identifier. The corresponding entity ID is
  `group.<object_id>`.

Includes:

- Group definitions may contain `!include` patterns.
- v1 intent: resolve includes during YAML load/build so the built `groups.yaml` is plain YAML.
- Supported include tags (v1):
  - `!include`
  - `!include_dir_list`
  - `!include_dir_merge_list`
  - `!include_dir_named`
  - `!include_dir_merge_named`

### Module index/browser support

Add `groups` to:

- `MODULE_BROWSER_DOMAINS`
- `MODULE_DOMAIN_MAP`

### Watch/sync inclusion rules

Update:

- `should_sync_yaml_modules()`
- `list_changed_domains()`
- preview domain-path set

So changes to `groups.yaml`, `groups/*.yaml`, and `packages/*/groups.yaml` participate correctly.

## Tests

Add unit tests under `addons/homeassistant_gitops/tests/`:

- Sync round-trip for groups mapping domain:
  - modules -> domain (build)
  - domain -> unassigned (update)
- Index includes:
  - one-offs module for `groups/` (excluding `groups/groups.unassigned.yaml`)
  - unassigned module for `groups/groups.unassigned.yaml` when present

## Acceptance criteria

- YAML Modules can sync groups between `groups.yaml` and module files.
- Groups appear in the module browser/index like other domains.
- Item APIs can list/read/write individual group entries.
